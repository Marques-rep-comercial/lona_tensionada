<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Lona Tensionada Iluminada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .result-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .result-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1d4ed8; /* blue-700 */
        }
        .result-card .detail {
            font-size: 0.8rem;
            color: #6b7280; /* gray-500 */
        }
        #downloadPdfBtn {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-6xl bg-white rounded-2xl shadow-lg p-6 md:p-8">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Calculadora de Lona Tensionada</h1>
            <p class="text-gray-500 mt-2">Calcule os materiais para cada lona e adicione ao projeto para somar os totais.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Input Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-2 border-b pb-3">Dimensões e Forma</h2>
                <p class="text-red-600 text-sm font-semibold my-4">*Atenção para respeitar as seguintes medidas de altura das lonas (1.80m, 2.80m e 5.80m) todas com 100 metros lineares.</p>

                <!-- Shape Selector -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Tipo de Forma</label>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="shape" value="rectangle" class="form-radio h-4 w-4 text-blue-600" checked>
                            <span class="ml-2 text-gray-700">Retângulo ou Quadrado</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="shape" value="circle" class="form-radio h-4 w-4 text-blue-600">
                            <span class="ml-2 text-gray-700">Círculo</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="shape" value="ellipse" class="form-radio h-4 w-4 text-blue-600">
                            <span class="ml-2 text-gray-700">Elipse (Oval)</span>
                        </label>
                         <label class="flex items-center">
                            <input type="radio" name="shape" value="custom" class="form-radio h-4 w-4 text-blue-600">
                            <span class="ml-2 text-gray-700">Polígono Irregular</span>
                        </label>
                    </div>
                </div>

                <!-- Profile Selector -->
                <div class="mb-4">
                    <label for="profileType" class="block text-sm font-medium text-gray-600 mb-1">Tipo de Perfil</label>
                    <select id="profileType" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="2.5" data-name='Perfil "H"'>Perfil "H" (barras de 2.5m)</option>
                        <option value="2" data-name='Perfil "H" Flexível'>Perfil "H" Flexível (barras de 2m)</option>
                        <option value="3" data-name='Perfil "E" Sobrepor'>Perfil "E" Sobrepor (barras de 3m)</option>
                    </select>
                </div>
                
                <!-- Inputs for dimensions -->
                <div id="dimensionsInputs" class="space-y-4">
                    <!-- Rectangle Inputs -->
                    <div id="rectangleInputs">
                        <div>
                            <label for="comprimento" class="block text-sm font-medium text-gray-600 mb-1">Comprimento (metros)</label>
                            <input type="number" id="comprimento" value="2.5" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="altura" class="block text-sm font-medium text-gray-600 mb-1">Altura (metros)</label>
                            <input type="number" id="altura" value="1.5" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <!-- Circle Input (hidden by default) -->
                    <div id="circleInputs" class="hidden">
                        <div>
                            <label for="diametro" class="block text-sm font-medium text-gray-600 mb-1">Diâmetro (metros)</label>
                            <input type="number" id="diametro" value="2.0" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                     <!-- Ellipse Inputs (hidden by default) -->
                    <div id="ellipseInputs" class="hidden">
                        <div>
                            <label for="eixoMaior" class="block text-sm font-medium text-gray-600 mb-1">Eixo Maior (metros)</label>
                            <input type="number" id="eixoMaior" value="3.0" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="eixoMenor" class="block text-sm font-medium text-gray-600 mb-1">Eixo Menor (metros)</label>
                            <input type="number" id="eixoMenor" value="2.0" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <!-- Custom Shape Inputs (hidden by default) -->
                    <div id="customInputs" class="hidden space-y-4">
                        <div id="customSidesContainer" class="space-y-2">
                             <!-- Dynamic side inputs will be added here -->
                        </div>
                        <button id="addSideBtn" type="button" class="w-full text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">Adicionar Medida</button>
                        <div>
                            <label for="customArea" class="block text-sm font-medium text-gray-600 mb-1">Área (m²)</label>
                            <input type="number" id="customArea" value="5.0" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Necessário para cálculo de LED">
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Configurações Avançadas</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="potenciaFita" class="block text-sm font-medium text-gray-600 mb-1">Potência da Fita (W/m)</label>
                            <input type="number" id="potenciaFita" value="6" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="espacamentoFita" class="block text-sm font-medium text-gray-600 mb-1">Espaçamento entre Fitas (m)</label>
                            <input type="number" id="espacamentoFita" value="0.07" step="0.01" class="w-full p-3 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 flex flex-col">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Quantitativos da Lona Atual</h2>
                <div id="results" class="grid grid-cols-2 sm:grid-cols-2 gap-4">
                    <!-- Results will be injected here -->
                </div>
                 <div class="mt-6 p-4 bg-green-100 border border-green-300 rounded-lg text-center">
                    <h3 class="font-bold text-green-800">Fonte de Alimentação</h3>
                    <div id="fonteResult" class="result-card text-center">
                         <!-- Fonte result will be injected here -->
                    </div>
                </div>
                <div class="mt-auto pt-6">
                     <button id="addToProjectBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        Adicionar Lona a lista
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Project List Section -->
        <div id="projectSection" class="mt-8 pt-8 border-t hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold text-gray-800">Lista do Projeto</h2>
                <button id="clearProjectBtn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 transition-colors text-sm">Limpar Projeto</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div id="projectItemsList" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Project items will be listed here -->
                </div>
                <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">Total do Projeto</h3>
                    <div id="projectTotals" class="space-y-2">
                        <!-- Project totals will be displayed here -->
                    </div>
                     <button id="downloadPdfBtn" class="w-full mt-6 bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition-colors">
                        Baixar PDF do Projeto
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-600 font-semibold">REPRESENTANTE COMERCIAL</p>
            <p class="text-sm text-gray-500">Marcio Marques - (81) 9.9464-5392</p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // --- DOM Element References ---
        const comprimentoInput = document.getElementById('comprimento');
        const alturaInput = document.getElementById('altura');
        const diametroInput = document.getElementById('diametro');
        const eixoMaiorInput = document.getElementById('eixoMaior');
        const eixoMenorInput = document.getElementById('eixoMenor');
        const customAreaInput = document.getElementById('customArea');
        const customSidesContainer = document.getElementById('customSidesContainer');
        const addSideBtn = document.getElementById('addSideBtn');
        const potenciaFitaInput = document.getElementById('potenciaFita');
        const espacamentoFitaInput = document.getElementById('espacamentoFita');
        const resultsDiv = document.getElementById('results');
        const fonteResultDiv = document.getElementById('fonteResult');
        const shapeRadios = document.querySelectorAll('input[name="shape"]');
        const profileTypeSelect = document.getElementById('profileType');
        const rectangleInputsDiv = document.getElementById('rectangleInputs');
        const circleInputsDiv = document.getElementById('circleInputs');
        const ellipseInputsDiv = document.getElementById('ellipseInputs');
        const customInputsDiv = document.getElementById('customInputs');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const addToProjectBtn = document.getElementById('addToProjectBtn');
        const clearProjectBtn = document.getElementById('clearProjectBtn');
        const projectSection = document.getElementById('projectSection');
        const projectItemsList = document.getElementById('projectItemsList');
        const projectTotals = document.getElementById('projectTotals');

        let lastCalculatedResults = {};
        let projectItems = [];

        /**
         * Toggles input visibility based on selected shape.
         */
        function handleShapeChange() {
            const selectedShape = document.querySelector('input[name="shape"]:checked').value;
            rectangleInputsDiv.classList.add('hidden');
            circleInputsDiv.classList.add('hidden');
            ellipseInputsDiv.classList.add('hidden');
            customInputsDiv.classList.add('hidden');

            if (selectedShape === 'rectangle') rectangleInputsDiv.classList.remove('hidden');
            else if (selectedShape === 'circle') circleInputsDiv.classList.remove('hidden');
            else if (selectedShape === 'ellipse') ellipseInputsDiv.classList.remove('hidden');
            else if (selectedShape === 'custom') {
                customInputsDiv.classList.remove('hidden');
                if (customSidesContainer.children.length === 0) {
                    addSideInput(); addSideInput(); addSideInput();
                }
            }
            calculateMaterials();
        }

        function relabelCustomSides() {
            const sideDivs = customSidesContainer.children;
            for (let i = 0; i < sideDivs.length; i++) {
                const label = sideDivs[i].querySelector('label');
                if (label) label.textContent = `Lado ${i + 1} (metros)`;
            }
        }

        function addSideInput() {
            const sideCount = customSidesContainer.children.length + 1;
            const newSideDiv = document.createElement('div');
            newSideDiv.className = 'flex items-center gap-2';
            newSideDiv.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-1 flex-grow">Lado ${sideCount} (metros)</label>
                <input type="number" class="w-full p-2 bg-white border border-gray-300 rounded-md shadow-sm custom-side-input" value="1.0">
                <button type="button" class="remove-side-btn bg-red-500 text-white font-bold w-8 h-8 rounded-md hover:bg-red-600 flex items-center justify-center">-</button>
            `;
            customSidesContainer.appendChild(newSideDiv);
            newSideDiv.querySelector('input').addEventListener('input', calculateMaterials);
            newSideDiv.querySelector('.remove-side-btn').addEventListener('click', () => {
                newSideDiv.remove();
                relabelCustomSides();
                calculateMaterials();
            });
        }

        function calculateMaterials() {
            const selectedShape = document.querySelector('input[name="shape"]:checked').value;
            const potenciaFita = parseFloat(potenciaFitaInput.value) || 0;
            const espacamentoFita = parseFloat(espacamentoFitaInput.value) || 0.07;
            const selectedProfileOption = profileTypeSelect.options[profileTypeSelect.selectedIndex];
            const profileBarLength = parseFloat(selectedProfileOption.value) || 2.5;
            const profileName = selectedProfileOption.getAttribute('data-name');
            const profileUnit = `barras de ${profileBarLength.toString().replace('.',',')}m`;

            let perimetro = 0, area = 0, lonaLinearDimension = 0, dimensionsText = '', shapeLabel = '';
            const rawDimensions = {};

            if (selectedShape === 'rectangle') {
                const c = parseFloat(comprimentoInput.value) || 0;
                const a = parseFloat(alturaInput.value) || 0;
                rawDimensions.comprimento = c; rawDimensions.altura = a;
                perimetro = (c + a) * 2; area = c * a; lonaLinearDimension = c;
                dimensionsText = `Comprimento: ${c}m, Altura: ${a}m`;
                shapeLabel = c === a ? 'Quadrado' : 'Retângulo';
            } else if (selectedShape === 'circle') {
                const d = parseFloat(diametroInput.value) || 0;
                rawDimensions.diametro = d;
                perimetro = Math.PI * d; area = Math.PI * Math.pow(d / 2, 2); lonaLinearDimension = d;
                dimensionsText = `Diâmetro: ${d}m`; shapeLabel = 'Círculo';
            } else if (selectedShape === 'ellipse') {
                const eM = parseFloat(eixoMaiorInput.value) || 0;
                const em = parseFloat(eixoMenorInput.value) || 0;
                rawDimensions.eixoMaior = eM; rawDimensions.eixoMenor = em;
                const a = eM / 2, b = em / 2;
                perimetro = Math.PI * (3 * (a + b) - Math.sqrt((3 * a + b) * (a + 3 * b)));
                area = Math.PI * a * b; lonaLinearDimension = eM;
                dimensionsText = `Eixo Maior: ${eM}m, Eixo Menor: ${em}m`;
                shapeLabel = 'Elipse';
            } else if (selectedShape === 'custom') {
                const sides = Array.from(document.querySelectorAll('.custom-side-input')).map(i => parseFloat(i.value) || 0);
                rawDimensions.sides = sides;
                rawDimensions.area = parseFloat(customAreaInput.value) || 0;
                perimetro = sides.reduce((s, c) => s + c, 0);
                area = rawDimensions.area;
                lonaLinearDimension = Math.max(...sides, 0);
                dimensionsText = `Lados: ${sides.join('m, ')}m. Área: ${area}m²`;
                shapeLabel = 'Polígono Irregular';
            }

            const metragemFita = espacamentoFita > 0 ? area / espacamentoFita : 0;
            const fontePotencia = (metragemFita * potenciaFita) * 1.20;

            const resultsData = [
                { title: 'Lona', unit: 'metros linear', value: lonaLinearDimension },
                { title: 'Silicone', unit: 'metros', value: perimetro },
                { title: profileName, unit: profileUnit, value: perimetro / profileBarLength },
                { title: 'Fita de LED', unit: 'rolos de 3m', value: metragemFita / 3, linearMeters: metragemFita },
            ];
            
            lastCalculatedResults = {
                shape: shapeLabel, dimensions: dimensionsText, rawDimensions, profile: `${profileName} (${profileUnit})`,
                materials: resultsData, power: { value: fontePotencia, rounded: Math.ceil(fontePotencia) }
            };

            resultsDiv.innerHTML = '';
            resultsData.forEach(item => {
                let extraDetailHTML = `<p class="detail">(${item.value.toFixed(2)} exato)</p>`;
                if (item.linearMeters !== undefined) extraDetailHTML += `<p class="detail">${item.linearMeters.toFixed(2)}m lineares</p>`;
                resultsDiv.innerHTML += `
                    <div class="result-card bg-white p-4 rounded-lg shadow-sm text-center border">
                        <h3>${item.title}</h3> <p class="value">${Math.ceil(item.value)}</p>
                        <p class="detail">${item.unit}</p> ${extraDetailHTML}
                    </div>`;
            });
            fonteResultDiv.innerHTML = `
                <p class="value">${lastCalculatedResults.power.rounded} W</p>
                <p class="detail">Potência Recomendada (+20%)</p>
                <p class="detail">(${lastCalculatedResults.power.value.toFixed(2)} W exato)</p>`;
        }

        function addCurrentItemToProject() {
            projectItems.push(JSON.parse(JSON.stringify(lastCalculatedResults)));
            updateProjectUI();
        }

        function updateProjectUI() {
            projectSection.classList.remove('hidden');
            
            // Render list
            projectItemsList.innerHTML = '';
            projectItems.forEach((item, index) => {
                projectItemsList.innerHTML += `
                    <div class="bg-white p-3 rounded-lg shadow-sm border flex justify-between items-center">
                        <div>
                            <p class="font-bold">${index + 1}. ${item.shape}</p>
                            <p class="text-xs text-gray-600">${item.dimensions}</p>
                        </div>
                    </div>
                `;
            });

            // Calculate and render totals
            const totals = {};
            let totalPower = 0;
            projectItems.forEach(item => {
                item.materials.forEach(mat => {
                    const key = mat.title;
                    if (!totals[key]) totals[key] = { value: 0, unit: mat.unit, linearMeters: 0 };
                    totals[key].value += mat.value;
                    if (mat.linearMeters) totals[key].linearMeters += mat.linearMeters;
                });
                totalPower += item.power.value;
            });

            projectTotals.innerHTML = '';
            for (const key in totals) {
                const total = totals[key];
                let extraDetailHTML = `(${total.value.toFixed(2)} exato)`;
                if (key === 'Fita de LED') extraDetailHTML += `, ${total.linearMeters.toFixed(2)}m lineares`;

                projectTotals.innerHTML += `
                    <div class="flex justify-between items-baseline">
                        <span class="font-semibold text-gray-800">${key}:</span>
                        <span class="font-bold text-lg text-blue-700">${Math.ceil(total.value)} ${total.unit.split(' ')[0]}</span>
                    </div>
                    <p class="text-xs text-gray-500 text-right -mt-2">${extraDetailHTML}</p>
                `;
            }
            projectTotals.innerHTML += `
                <div class="flex justify-between items-baseline mt-4 border-t pt-2">
                    <span class="font-semibold text-gray-800">Fonte de Alimentação:</span>
                    <span class="font-bold text-lg text-blue-700">${Math.ceil(totalPower)} W</span>
                </div>
                 <p class="text-xs text-gray-500 text-right -mt-2">(+20% margem)</p>
            `;
        }

        function clearProject() {
            projectItems = [];
            projectSection.classList.add('hidden');
            projectItemsList.innerHTML = '';
            projectTotals.innerHTML = '';
        }

        function downloadProjectPDF() {
            const doc = new jsPDF();
            const today = new Date().toLocaleDateString('pt-BR');
            let lastY = 29;

            doc.setFontSize(18);
            doc.text("Orçamento Consolidado de Projeto", 14, 22);
            doc.setFontSize(11); doc.setTextColor(100);
            doc.text(`Data: ${today}`, 14, lastY);

            // --- INVERTED ORDER: DETAILS FIRST ---
            doc.setFontSize(14); doc.setTextColor(0);
            doc.text("Detalhamento por Lona", 14, lastY + 15);
            lastY += 20;

            // Individual Items
            projectItems.forEach((data, index) => {
                if (lastY > 200) { doc.addPage(); lastY = 22; }
                
                doc.setFontSize(12); doc.setTextColor(0);
                doc.text(`Item ${index + 1}: ${data.shape}`, 14, lastY);
                doc.autoTable({
                    startY: lastY + 3,
                    head: [['Dimensões', 'Tipo de Perfil']],
                    body: [[data.dimensions, data.profile]],
                    theme: 'striped'
                });
                lastY = doc.autoTable.previous.finalY;

                // --- DRAWING LOGIC ---
                if (data.shape !== 'Polígono Irregular') {
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.text(`Desenho Representativo`, 14, lastY + 8);
                    const drawStartY = lastY + 12;
                    const drawAreaWidth = doc.internal.pageSize.width - 28;
                    const drawCenterX = 14 + drawAreaWidth / 2;
                    const drawMaxHeight = 40;
                    let scale, w, h, x, y;

                    doc.setLineWidth(0.2);
                    doc.setDrawColor(50);
                    doc.setFontSize(8);
                    doc.setTextColor(80);

                    if (data.shape === 'Retângulo' || data.shape === 'Quadrado') {
                        const rawW = data.rawDimensions.comprimento;
                        const rawH = data.rawDimensions.altura;
                        if (rawW > 0 && rawH > 0) {
                            scale = Math.min((drawAreaWidth / rawW) * 0.5, (drawMaxHeight / rawH) * 0.8);
                            w = rawW * scale;
                            h = rawH * scale;
                            x = drawCenterX - w / 2;
                            y = drawStartY;
                            doc.rect(x, y, w, h);
                            doc.line(x, y + h + 5, x + w, y + h + 5);
                            doc.line(x, y + h + 3, x, y + h + 7);
                            doc.line(x + w, y + h + 3, x + w, y + h + 7);
                            doc.text(`${rawW}m`, x + w / 2, y + h + 9, { align: 'center' });
                            doc.line(x - 5, y, x - 5, y + h);
                            doc.line(x - 7, y, x - 3, y);
                            doc.line(x - 7, y + h, x - 3, y + h);
                            doc.text(`${rawH}m`, x - 7, y + h / 2, { align: 'right', baseline: 'middle' });
                        }
                    } else if (data.shape === 'Círculo') {
                        const rawD = data.rawDimensions.diametro;
                        if (rawD > 0) {
                            const r = (rawD / 2) * (Math.min(drawAreaWidth, drawMaxHeight) / rawD * 0.6);
                            x = drawCenterX;
                            y = drawStartY + r;
                            doc.circle(x, y, r);
                            doc.line(x - r, y, x + r, y);
                            doc.line(x - r, y - 2, x - r, y + 2);
                            doc.line(x + r, y - 2, x + r, y + 2);
                            doc.text(`${rawD}m`, x, y + 6, { align: 'center' });
                        }
                    } else if (data.shape === 'Elipse') {
                        const rawW = data.rawDimensions.eixoMaior;
                        const rawH = data.rawDimensions.eixoMenor;
                        if (rawW > 0 && rawH > 0) {
                            scale = Math.min((drawAreaWidth / rawW) * 0.5, (drawMaxHeight / rawH) * 0.8);
                            const rx = (rawW / 2) * scale;
                            const ry = (rawH / 2) * scale;
                            x = drawCenterX;
                            y = drawStartY + ry;
                            doc.ellipse(x, y, rx, ry);
                            doc.line(x - rx, y, x + rx, y);
                            doc.text(`${rawW}m`, x, y + 4, { align: 'center' });
                            doc.line(x, y - ry, x, y + ry);
                            doc.text(`${rawH}m`, x + 4, y, { align: 'left', baseline: 'middle' });
                        }
                    }
                    lastY = drawStartY + drawMaxHeight + 5;
                } else {
                    lastY += 5;
                }
                
                const tableBody = data.materials.map(item => {
                    let unitText = item.unit;
                    if (item.linearMeters) unitText += ` (${item.linearMeters.toFixed(2)}m)`;
                    return [item.title, Math.ceil(item.value), unitText, item.value.toFixed(2)];
                });
                 tableBody.push(["Fonte (+20%)", `${data.power.rounded} W`, `Potência Recomendada`, data.power.value.toFixed(2)]);

                doc.autoTable({
                    startY: lastY + 2,
                    head: [['Material', 'Qtd. (Arred.)', 'Unidade', 'Valor Exato']],
                    body: tableBody,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fontSize: 10 }
                });
                lastY = doc.autoTable.previous.finalY + 15;
            });

            // --- TOTALS LAST ---
            if (projectItems.length > 0) doc.addPage();
            lastY = 22;
            doc.setFontSize(14); doc.setTextColor(0);
            doc.text("Total Geral dos Materiais", 14, lastY);
            
            const totalTableBody = [];
            const totals = {};
            let totalPower = 0;
             projectItems.forEach(item => {
                item.materials.forEach(mat => {
                    const key = mat.title;
                    if (!totals[key]) totals[key] = { value: 0, unit: mat.unit, linearMeters: 0 };
                    totals[key].value += mat.value;
                    if (mat.linearMeters) totals[key].linearMeters += mat.linearMeters;
                });
                totalPower += item.power.value;
            });
            for (const key in totals) {
                 const total = totals[key];
                 let unitText = total.unit;
                 if (key === 'Fita de LED') unitText += ` (${total.linearMeters.toFixed(2)}m)`;
                 totalTableBody.push([key, Math.ceil(total.value), unitText, total.value.toFixed(2)]);
            }
            totalTableBody.push(["Fonte (+20%)", `${Math.ceil(totalPower)} W`, `Potência Total`, totalPower.toFixed(2)]);

            doc.autoTable({
                startY: lastY + 3,
                head: [['Material', 'Qtd. (Arred.)', 'Unidade', 'Valor Exato']],
                body: totalTableBody,
                theme: 'grid'
            });

            const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
            doc.setFontSize(10); doc.setTextColor(100);
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.text("REPRESENTANTE COMERCIAL: Marcio Marques - (81) 9.9464-5392", 14, pageHeight - 10);
            }

            doc.save(`projeto-lona-${new Date().getTime()}.pdf`);
        }
        
        // --- Event Listeners ---
        const allInputs = [comprimentoInput, alturaInput, diametroInput, eixoMaiorInput, eixoMenorInput, customAreaInput, potenciaFitaInput, espacamentoFitaInput, profileTypeSelect];
        allInputs.forEach(input => input.addEventListener('input', calculateMaterials));
        shapeRadios.forEach(radio => radio.addEventListener('change', handleShapeChange));
        downloadPdfBtn.addEventListener('click', downloadProjectPDF);
        addToProjectBtn.addEventListener('click', addCurrentItemToProject);
        clearProjectBtn.addEventListener('click', clearProject);
        addSideBtn.addEventListener('click', addSideInput);

        // --- Initial Setup ---
        window.addEventListener('load', () => {
            handleShapeChange();
        });

    </script>

</body>
</html>
